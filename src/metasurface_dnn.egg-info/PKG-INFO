Metadata-Version: 2.4
Name: metasurface-dnn
Version: 0.1.0
Summary: Metasurface-based diffractive neural network (3-layer phase-only) simulation for tumor detection
Author: Course Project
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: numpy>=1.23
Requires-Dist: pyyaml>=6.0
Requires-Dist: tqdm>=4.66
Requires-Dist: matplotlib>=3.7
Requires-Dist: torch>=2.0
Requires-Dist: pillow>=10.0

# Metasurface-based Diffractive Neural Network (3-layer) | Tumor Detection (Simulation)

本仓库实现一个**基于超表面(phase-only metasurface)的衍射神经网络**，用于**乳腺肿瘤/皮肤肿瘤二分类检测**（只需要仿真结果，不做实体加工）。

你需要设计 3 层超表面的 meta-atom 分布（等效为每层的空间相位分布 $\phi(x,y)\in[0,2\pi)$ ），让入射电磁波在自由空间传播 + 相位调制后，在探测面形成可区分的能量分布，从而完成分类。

本实现参考了仓库中已有的衍射网络资料（如 [onn-simulation](onn-simulation/README.md) 的“传播层 + 调制层 + 探测层”思想），但这里**严格按题目要求：3 层、相位-only、仿真为主**。

## 1. 物理原理（电磁/衍射到可训练网络）

### 1.1 标量衍射与角谱法（Angular Spectrum）
在均匀介质中，单频电磁场可表示为复振幅形式：
$$E(x,y,z,t)=\Re\{U(x,y,z) e^{j\omega t}\}.$$

在近似为标量波（忽略极化耦合、只考虑一个分量）时，平面 $z$ 上的场 $U(x,y,z)$ 的传播可通过角谱法表示：

1) 对 $z=0$ 平面的场做二维傅里叶变换得到角谱 $A(f_x,f_y)$。

2) 每个空间频率分量在传播距离 $z$ 后乘上传输函数：
$$H(f_x,f_y;z)=\exp\left(j k z\sqrt{1-(\lambda f_x)^2-(\lambda f_y)^2}\right),$$
其中 $k=\frac{2\pi n_0}{\lambda}$，$n_0$ 为背景折射率。

3) 逆傅里叶变换得到传播后的场。

在实现中，为避免非传播(消逝)分量带来的数值问题，默认会对 $1-(\lambda f_x)^2-(\lambda f_y)^2<0$ 的部分做 band-limit mask（只保留传播波）。

### 1.2 超表面等效为“相位掩膜”
题目给定 meta-atom 结构可实现 $0\sim2\pi$ 连续相位调制。对标量场近似下，一层超表面可等效为：
$$U_\text{out}(x,y)=U_\text{in}(x,y)\,e^{j\phi(x,y)},\quad \phi\in[0,2\pi).$$

因此 3 层超表面 + 4 段自由空间传播（输入→L1→L2→L3→探测面）可以写成“可微物理算子”的串联。

### 1.3 为什么它是“神经网络”
网络的“参数”就是每层的相位分布 $\phi_1,\phi_2,\phi_3$；
前向传播就是电磁波的传播与调制；
损失函数把探测面的光强分布映射为分类分数（例如两个探测区域能量之差），用梯度下降即可训练相位掩膜。

本仓库实现一个二分类探测器：在探测面选取两个窗口区域 $R_0,R_1$，以
$$s_c=\sum_{(x,y)\in R_c} |U(x,y)|^2$$
作为 logits，经过 softmax 得到分类概率。

## 2. 项目结构（课程规范 / 可复现）

- 代码（核心实现）
	- [src/metasurface_dnn](src/metasurface_dnn)
		- [physics.py](src/metasurface_dnn/physics.py): 角谱法传播
		- [model.py](src/metasurface_dnn/model.py): 3 层相位-only DNN + 探测器
		- [train.py](src/metasurface_dnn/train.py): 训练并导出相位掩膜/指标
		- [simulate.py](src/metasurface_dnn/simulate.py): 生成仿真强度图与摘要
		- [prepare_dataset.py](src/metasurface_dnn/prepare_dataset.py): 把原始图片整理成 `npz`
		- [predict.py](src/metasurface_dnn/predict.py): 对指定 split 输出预测 CSV
		- [export_meta_atoms.py](src/metasurface_dnn/export_meta_atoms.py): 结合 LUT 将相位量化成 meta-atom 几何参数
- 配置
	- [configs/default.yaml](configs/default.yaml)
- 数据占位
	- [data/README.md](data/README.md)
- 输出占位
	- [outputs/README.md](outputs/README.md)
- meta-atom LUT 示例
	- [assets/meta_atom_lut_example.csv](assets/meta_atom_lut_example.csv)

注意：仓库中历史参考资料目录 `Diffractive-Deep-Neural-Networks/`、`onn-simulation/` 当前被 `.gitignore` 忽略；本项目的可复现实现在 `src/` 下，不依赖它们被提交。

## 3. 数据集约定（预留输入/输出）

### 3.1 推荐格式（processed）
把处理好的数据放在 `data/processed/`：

- `train.npz`, `val.npz`, `test.npz`

每个 `.npz` 内包含：
- `x`: `(N,H,W)` float32，取值建议归一化到 `[0,1]`（作为入射场幅度）
- `y`: `(N,)` int64，二分类标签 `0/1`

### 3.2 原始图片到 npz（raw → processed）
若你有原始图片数据，建议放为：

```
data/raw/train/0/*.png
data/raw/train/1/*.png
data/raw/val/0/*.png
data/raw/val/1/*.png
data/raw/test/0/*.png
data/raw/test/1/*.png
```

然后运行：

```
python -m metasurface_dnn.prepare_dataset --raw_root data/raw --image_size 128
```

### 3.3 没有真实数据时
为了“能跑通并产出仿真结果”，默认配置会在缺少 `data/processed/*.npz` 时自动生成一个小型**合成数据集**（仅用于管线自检，不代表医学有效性）。

## 4. 如何运行（训练 + 仿真 + 导出）

### 4.1 安装

```
pip install -r requirements.txt
pip install -e .
```

### 4.2 训练 3 层相位-only DNN

```
python -m metasurface_dnn.train --config configs/default.yaml
```

输出：
- `outputs/<timestamp>/metrics.json`
- `outputs/<timestamp>/phase_masks.npz`
- `outputs/checkpoints/best.pt`

### 4.3 生成仿真强度图（探测面）

```
python -m metasurface_dnn.simulate --config configs/default.yaml --checkpoint outputs/checkpoints/best.pt --n 8
```

输出：
- `outputs/simulations/<timestamp>/intensity_sample0.png`
- `outputs/simulations/<timestamp>/batch_inputs.npz`

### 4.4 预测输出 CSV（用于交作业的“预留输出”）

```
python -m metasurface_dnn.predict --config configs/default.yaml --checkpoint outputs/checkpoints/best.pt --split test
```

输出：`outputs/predictions/pred_test_<timestamp>.csv`

### 4.5 相位 → meta-atom 几何参数（需要你提供真实 LUT）

题目中“Detailed meta-atom structure is provided”通常意味着你有一个从相位到几何参数（如半径/宽度/高度/旋转角等）的映射表（LUT）。

本仓库提供了一个 LUT 示例文件占位：
- [assets/meta_atom_lut_example.csv](assets/meta_atom_lut_example.csv)

你需要用真实 LUT 替换它后运行：

```
python -m metasurface_dnn.export_meta_atoms \
	--phase_npz outputs/<timestamp>/phase_masks.npz \
	--lut_csv assets/meta_atom_lut_example.csv \
	--out_dir outputs/meta_atom_exports
```

## 5. 你需要按实验参数修改的地方

- [configs/default.yaml](configs/default.yaml)
	- `physics.wavelength_m`: 实验频段对应波长
	- `physics.pixel_size_m`: 采样间隔（等效 meta-atom pitch / 网格间距）
	- `physics.z_list_m`: 4 段传播距离（输入→L1→L2→L3→探测面）
	- `classifier.regions`: 两个探测窗口的位置（随采样尺寸/成像面设计调整）

## 6. 交付物建议（报告/截图）

- 训练收敛曲线：`metrics.json` 中的 loss/acc（可自行画图）
- 3 层相位分布：`phase_masks.npz`（可视化成 heatmap）
- 探测面强度分布：`intensity_sample0.png`
- 测试集预测表：`pred_test_<timestamp>.csv`
